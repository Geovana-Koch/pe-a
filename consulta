<?php
date_default_timezone_set('America/Sao_Paulo');
session_start();

require_once 'config.php'; 
$conexao = $pdo;


$filtro_data_inicio = $_GET['data_inicio'] ?? '';
$filtro_data_fim = $_GET['data_fim'] ?? '';
$filtro_assunto = $_GET['assunto'] ?? '';
$filtro_educador = $_GET['educador'] ?? '';


$where_conditions = [];
$params = [];

if (!empty($filtro_data_inicio)) {
    $where_conditions[] = "t.data_treinamento >= ?";
    $params[] = $filtro_data_inicio;
}

if (!empty($filtro_data_fim)) {
    $where_conditions[] = "t.data_treinamento <= ?";
    $params[] = $filtro_data_fim;
}

if (!empty($filtro_assunto)) {
    $where_conditions[] = "t.assunto LIKE ?";
    $params[] = "%$filtro_assunto%";
}

if (!empty($filtro_educador)) {
    $where_conditions[] = "t.nome_educador LIKE ?";
    $params[] = "%$filtro_educador%";
}

$where_sql = '';
if (!empty($where_conditions)) {
    $where_sql = "WHERE " . implode(" AND ", $where_conditions);
}


try {
    $sql = "SELECT t.*, 
                   COUNT(tp.id_participacao) as total_participantes,
                   SUM(CASE WHEN tp.hora_saida IS NULL THEN 1 ELSE 0 END) as presentes
            FROM Treinamentos t
            LEFT JOIN Treinamento_Participantes tp ON t.id_treinamento = tp.id_treinamento
            $where_sql
            GROUP BY t.id_treinamento
            ORDER BY t.data_treinamento DESC, t.hora_inicio DESC";

    $stmt = $conexao->prepare($sql);
    $stmt->execute($params);
    $treinamentos = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
} catch (PDOException $e) {
    $erro = "Erro ao buscar treinamentos: " . $e->getMessage();
    $treinamentos = [];
}


if (isset($_GET['exportar']) && $_GET['exportar'] == 'excel') {
    header('Content-Type: application/vnd.ms-excel');
    header('Content-Disposition: attachment; filename="consultatreinamentos_' . date('Y-m-d') . '.xls"');
    
    echo "<table border='1'>";
    echo "<tr>
            <th>ID</th>
            <th>Data</th>
            <th>Hora Início</th>
            <th>Hora Fim</th>
            <th>Assunto</th>
            <th>Educador</th>
            <th>Setor Educador</th>
            <th>Tipo Educador</th>
            <th>Matriz Anual</th>
            <th>Qualidade/Segurança</th>
            <th>Total Participantes</th>
            <th>Presentes</th>
          </tr>";
    
    foreach ($treinamentos as $treinamento) {
        echo "<tr>
                <td>{$treinamento['id_treinamento']}</td>
                <td>{$treinamento['data_treinamento']}</td>
                <td>{$treinamento['hora_inicio']}</td>
                <td>" . (!empty($treinamento['hora_fim']) ? $treinamento['hora_fim'] : '-') . "</td>
                <td>{$treinamento['assunto']}</td>
                <td>{$treinamento['nome_educador']}</td>
                <td>{$treinamento['setor_educador']}</td>
                <td>" . ($treinamento['educador_interno'] ? 'Interno' : 'Externo') . "</td>
                <td>" . ($treinamento['matriz_anual'] ? 'Sim' : 'Não') . "</td>
                <td>" . ($treinamento['qualidade_seguranca'] ? 'Sim' : 'Não') . "</td>
                <td>{$treinamento['total_participantes']}</td>
                <td>{$treinamento['presentes']}</td>
              </tr>";
    }
    
    echo "</table>";
    exit;
}
?>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Treinamentos - Módulo Bússola</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-color: #ecf0f1;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 60px;
        }
        
        .navbar {
            background-color: var(--primary-color) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .table th {
            background-color: var(--light-color);
        }
        
        .badge-status {
            font-size: 0.8em;
        }
        
        .status-finalizado {
            background-color: #28a745;
        }
        
        .status-andamento {
            background-color: #ffc107;
            color: #000;
        }
        
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 1rem 0;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .export-btn {
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            transform: scale(1.05);
        }
        
        .participant-badge {
            font-size: 0.85em;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <i class="bi bi-compass me-2"></i>
            Módulo Bússola - Consulta de Treinamentos
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="home.php"><i class="bi bi-house-door me-1"></i>Início</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="cracha.php"><i class="bi bi-plus-circle me-1"></i>Novo Treinamento</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="consulta.php"><i class="bi bi-search me-1"></i>Consulta</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="logout.php"><i class="bi bi-box-arrow-right me-1"></i>Sair</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <?php if (isset($erro)): ?>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i><?php echo $erro; ?>
                </div>
            <?php endif; ?>
            
            <div class="card">
                <div class="card-header">
                    <h1 class="h4 mb-0">Consulta de Treinamentos</h1>
                </div>
                <div class="card-body">
                    
                    <form method="get" action="">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label for="data_inicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="<?php echo $filtro_data_inicio; ?>">
                            </div>
                            <div class="col-md-3">
                                <label for="data_fim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="data_fim" name="data_fim" value="<?php echo $filtro_data_fim; ?>">
                            </div>
                            <div class="col-md-3">
                                <label for="assunto" class="form-label">Assunto</label>
                                <input type="text" class="form-control" id="assunto" name="assunto" value="<?php echo htmlspecialchars($filtro_assunto); ?>" placeholder="Palavra-chave">
                            </div>
                            <div class="col-md-3">
                                <label for="educador" class="form-label">Educador</label>
                                <input type="text" class="form-control" id="educador" name="educador" value="<?php echo htmlspecialchars($filtro_educador); ?>" placeholder="Nome do educador">
                            </div>
                            <div class="col-md-3">
                                <label for="participante" class="form-label">Participante</label>
                                <input type="text" class="form-control" id="participante" name="participante" value="<?php echo htmlspecialchars($filtro_educador); ?>" placeholder="Nome do participante">
                            </div>
                            <div class="col-md-12 mt-3">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-search me-1"></i>Filtrar
                                </button>
                                <a href="consulta.php" class="btn btn-secondary me-2">
                                    <i class="bi bi-x-circle me-1"></i>Limpar
                                </a>
                                <button type="submit" name="exportar" value="excel" class="btn btn-success export-btn">
                                    <i class="bi bi-file-earmark-excel me-1"></i>Exportar para Excel
                                </button>
                            </div>
                        </div>
                    </form>
                    
                   
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabela-treinamentos">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Hora Início</th>
                                    <th>Hora Fim</th>
                                    <th>Assunto</th>
                                    <th>Educador</th>
                                    <th>Participantes</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (count($treinamentos) > 0): ?>
                                    <?php foreach ($treinamentos as $treinamento): 
                                        $status = empty($treinamento['hora_fim']) ? 'andamento' : 'finalizado';
                                    ?>
                                    <tr>
                                        <td><?php echo $treinamento['id_treinamento']; ?></td>
                                        <td><?php echo date('d/m/Y', strtotime($treinamento['data_treinamento'])); ?></td>
                                        <td><?php echo date('H:i', strtotime($treinamento['hora_inicio'])); ?></td>
                                        <td><?php echo !empty($treinamento['hora_fim']) ? date('H:i', strtotime($treinamento['hora_fim'])) : '-'; ?></td>
                                        <td><?php echo htmlspecialchars($treinamento['assunto']); ?></td>
                                        <td><?php echo htmlspecialchars($treinamento['nome_educador']); ?></td>
                                        <td>
                                            <span class="badge bg-primary participant-badge">Total: <?php echo $treinamento['total_participantes']; ?></span>
                                            <?php if ($status == 'andamento'): ?>
                                                <span class="badge bg-success participant-badge">Presentes: <?php echo $treinamento['presentes']; ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <span class="badge badge-status <?php echo $status == 'finalizado' ? 'status-finalizado' : 'status-andamento'; ?>">
                                                <?php echo $status == 'finalizado' ? 'Finalizado' : 'Em Andamento'; ?>
                                            </span>
                                        </td>
                                        <td>
                                            <a href="detalhes_treinamento.php?id=<?php echo $treinamento['id_treinamento']; ?>" class="btn btn-sm btn-info" title="Ver detalhes">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="editar_treinamento.php?id=<?php echo $treinamento['id_treinamento']; ?>" class="btn btn-sm btn-warning" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                <?php else: ?>
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="alert alert-info mt-3">
                                                <i class="bi bi-info-circle me-2"></i>
                                                <?php echo (isset($_GET['data_inicio']) || isset($_GET['assunto']) || isset($_GET['educador'])) ? 
                                                    'Nenhum treinamento encontrado com os filtros aplicados.' : 
                                                    'Nenhum treinamento cadastrado ainda.'; ?>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                    
                    
                    <div class="alert alert-info mt-4">
                        <h5 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Como usar</h5>
                        <ul class="mb-0">
                            <li>Use os filtros para encontrar treinamentos específicos</li>
                            <li>Clique no ícone <i class="bi bi-eye"></i> para ver detalhes do treinamento</li>
                            <li>Clique no ícone <i class="bi bi-pencil"></i> para editar o treinamento</li>
                            <li>Use o botão "Exportar para Excel" para baixar os dados</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <p class="mb-0">Desenvolvido pelo setor de Tecnologia da Informação do HMSF</p>
        <p class="mb-0 small">Versão 1.0.0 | Último acesso: <?php echo date('d/m/Y H:i'); ?></p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        if (document.getElementById('data_fim').value === '') {
            document.getElementById('data_fim').valueAsDate = new Date();
        }
        
        
        if (document.getElementById('data_inicio').value === '') {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('data_inicio').valueAsDate = thirtyDaysAgo;
        }
    });
</script>
</body>
</html>
